use crate::config::{H, VRAM, W, WXH};
use crate::cpu::Cpu;
use minifb::{Scale, Window, WindowOptions};

pub struct Gpu {
    window: Window,
    buffer: Vec<u32>,
}

impl Gpu {
    pub fn new(title: &str) -> Self {
        let opts = WindowOptions {
            scale: Scale::X16,
            ..WindowOptions::default()
        };

        let mut window = Window::new(title, W, H, opts)
            .unwrap_or_else(|e| { panic!("{}", e); });

        window.set_background_color(0, 0, 0);
        window.set_target_fps(60);

        Gpu {
            window,
            buffer: vec![0u32; WXH],
        }
    }

    pub fn tick(&mut self, cpu: &mut Cpu) {
        if !self.window.is_open() {
            cpu.running = false;
        }

        if cpu.draw_flag {
            self.draw(cpu.vram);
        } else {
            self.window.update();
        }
    }

    pub fn draw(&mut self, vram: VRAM) {
        for x in 0..WXH {
            self.buffer[x] = if vram[x] { 0x00FF_FFFF } else { 0x0000_0000 };
        }

        self.window
            .update_with_buffer(&self.buffer, W, H)
            .unwrap_or_else(|e| { panic!("{}", e) })
    }

    pub fn splash(&mut self, cpu: &mut Cpu) {
        let mut counter = 0;

        for i in 0..256 {
            let pixels = format!("{:08b}", SPLASH_0XID8[i]);

            for c in pixels.chars() {
                cpu.vram[counter] = c != '1';
                counter += 1;
            }
        }
    }
}

const SPLASH_0XID8: [u8; 256] = [
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x81, 0xff, 0xfe, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0x81, 0xff, 0xfe, 0x60, 0x1f, 0x81, 0xff,
    0xfe, 0x7e, 0x7f, 0xfe, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x7f, 0xfe, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x78, 0x67, 0xe6, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x78, 0x67, 0xe6, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x66, 0x79, 0x9e, 0x67, 0xe7, 0x81, 0xff,
    0xfe, 0x66, 0x78, 0x1e, 0x67, 0xe7, 0x81, 0xff,
    0xfe, 0x1e, 0x7c, 0x3e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x1e, 0x7c, 0x3e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x78, 0x1e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x79, 0x9e, 0x67, 0xe6, 0x7e, 0x7f,
    0xff, 0x81, 0xe7, 0xe6, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0x81, 0xe7, 0xe6, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x06, 0x37, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xd6, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x1d, 0xf5, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0x13, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x7d, 0xd5, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xd6, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x03, 0xfe, 0x37, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
];
