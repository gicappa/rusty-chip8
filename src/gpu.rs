use std::ptr::addr_of_mut;
use crate::config::{H, VRAM, W, WXH};
use crate::cpu::Cpu;
use minifb::{Key, Scale, Window, WindowOptions};

pub struct Gpu {
    window: Window,
    buffer: Vec<u32>,
}

impl Gpu {
    pub fn new(title: &str) -> Self {
        let opts = WindowOptions {
            scale: Scale::X16,
            ..WindowOptions::default()
        };

        let mut window = Window::new(title, W, H, opts)
            .unwrap_or_else(|e| { panic!("{}", e); });

        window.set_background_color(0, 0, 0);
        window.set_target_fps(60);

        Gpu {
            window,
            buffer: vec![0u32; WXH],
        }
    }

    pub fn tick(&mut self, cpu: &mut Cpu) {
        if !self.window.is_open() {
            cpu.running = false;
        }

        self.check_input(cpu);

        if cpu.draw_flag {
            self.draw(cpu.vram);
        } else {
            self.window.update();
        }
    }

    pub fn check_input(&self, cpu: &mut Cpu) {
        let keypad = [
            Key::Key1, Key::Key2, Key::Key3, Key::Key4,
            Key::Q, Key::W, Key::E, Key::R,
            Key::A, Key::S, Key::D, Key::F,
            Key::Z, Key::X, Key::C, Key::V,
        ];

        for (i, key) in keypad.iter().enumerate() {
            if self.window.is_key_down(*key) {
                cpu.keypad[i]=true;
            }

            if self.window.is_key_released(*key) {
                cpu.keypad[i]=false;
            }
        }
    }

    pub fn draw(&mut self, vram: VRAM) {
        for x in 0..WXH {
            self.buffer[x] = if vram[x] { 0x00FF_FFFF } else { 0x0000_0000 };
        }

        self.window
            .update_with_buffer(&self.buffer, W, H)
            .unwrap_or_else(|e| { panic!("{}", e) })
    }

    pub fn panic(&mut self, cpu: &mut Cpu) {
        let mut counter = 0;

        for i in 0..256 {
            let pixels = format!("{:08b}", PANIC_0XID8[i]);

            for c in pixels.chars() {
                cpu.vram[counter] = c != '1';
                counter += 1;
            }
        }
    }
}

const _SPLASH_0XID8: [u8; 256] = [
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x81, 0xff, 0xfe, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0x81, 0xff, 0xfe, 0x60, 0x1f, 0x81, 0xff,
    0xfe, 0x7e, 0x7f, 0xfe, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x7f, 0xfe, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x78, 0x67, 0xe6, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x78, 0x67, 0xe6, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x66, 0x79, 0x9e, 0x67, 0xe7, 0x81, 0xff,
    0xfe, 0x66, 0x78, 0x1e, 0x67, 0xe7, 0x81, 0xff,
    0xfe, 0x1e, 0x7c, 0x3e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x1e, 0x7c, 0x3e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x78, 0x1e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x79, 0x9e, 0x67, 0xe6, 0x7e, 0x7f,
    0xff, 0x81, 0xe7, 0xe6, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0x81, 0xe7, 0xe6, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x06, 0x37, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xd6, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x1d, 0xf5, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0x13, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x00, 0x7d, 0xd5, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xd6, 0xff,
    0xfe, 0x00, 0x00, 0x00, 0x03, 0xfe, 0x37, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
];

const PANIC_0XID8: [u8; 256] = [
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xfe, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0x81, 0xff, 0xfe, 0x60, 0x1f, 0x81, 0xff, 0xfe, 0x7e, 0x7f, 0xfe, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x7f, 0xfe, 0x67, 0xe6, 0x7e, 0x7f, 0xfe, 0x78, 0x67, 0xe6, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x78, 0x67, 0xe6, 0x67, 0xe6, 0x7e, 0x7f, 0xfe, 0x66, 0x79, 0x9e, 0x67, 0xe7, 0x81, 0xff,
    0xfe, 0x66, 0x78, 0x1e, 0x67, 0xe7, 0x81, 0xff, 0xfe, 0x1e, 0x7c, 0x3e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x1e, 0x7c, 0x3e, 0x67, 0xe6, 0x7e, 0x7f, 0xfe, 0x7e, 0x78, 0x1e, 0x67, 0xe6, 0x7e, 0x7f,
    0xfe, 0x7e, 0x79, 0x9e, 0x67, 0xe6, 0x7e, 0x7f, 0xff, 0x81, 0xe7, 0xe6, 0x60, 0x1f, 0x81, 0xff,
    0xff, 0x81, 0xe7, 0xe6, 0x60, 0x1f, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xf9, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x3b, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xf7, 0x3b, 0xe3, 0x8d, 0xd6, 0x37, 0xff, 0xff, 0xef, 0x3d, 0xed, 0x74, 0xd5, 0xd7, 0xff,
    0xff, 0xef, 0x3d, 0xed, 0x75, 0x55, 0xf7, 0xff, 0xff, 0xef, 0x3d, 0xe3, 0x05, 0x95, 0xf7, 0xff,
    0xff, 0xef, 0xfd, 0xef, 0x75, 0xd5, 0xdf, 0xff, 0xff, 0xf7, 0x3b, 0xef, 0x75, 0xd6, 0x37, 0xff,
    0xff, 0xf7, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
];